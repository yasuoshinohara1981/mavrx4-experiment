## 概要
- **目的**: シンプルなカールノイズベースのGPGPUパーティクルシステム（約150万粒の球体マッピング）
- **レンダリング方式**: WebGPU（three/webgpu）

## 使用技術・ライブラリ
- **SimpleParticleSystem**: ON
  - パーティクル数: 約150万粒（1225x1225グリッド）
  - 初期形状: 球体マッピング
  - 更新方式: FULL（毎フレーム全粒更新）またはHALF（偶数/奇数を交互）
  - ノイズモード: sphereMapping（デフォルト）またはflowOnSphere
  - 圧力モード: ON（デフォルト、Track5で制御）
  - LFOモード: OFF（デフォルト、無効化）
- **WebGPU**: ON
  - レンダリング: three/webgpu
- **ポストプロセッシング**: ON
  - Bloom: ON（conf.bloomに依存）
  - 色反転エフェクト: ON（Track2）
  - 色収差エフェクト: ON（Track3）
  - グリッチエフェクト: ON（Track4）
- **HDR環境マップ**: ON
  - ファイル: `autumn_field_puresky_1k.hdr`
  - キャッシュ: 有効（loadHdrCached使用）
- **グリッド/ルーラー**: ON
  - 3Dグリッド: ON（GridRuler3D、デフォルトON）
  - 境界Box: ON（ワイヤーフレーム表示）
- **カメラパーティクル**: ON
  - カメラ数: 8台（8種類のモード）
  - カメラモード:
    - 0: frontWide（フロント・ワイド）
    - 1: frontMedium（フロント・ミディアム）
    - 2: closeup（クローズアップ）
    - 3: sidePan（サイド・パン）
    - 4: offCenter（オフセンター固定）
    - 5: slowOrbit（スロー・オービット）
    - 6: follow（フォロー、Track5の圧力位置を追う）
    - 7: still（静止ショット）
  - 移動範囲: 球体の外側（最小距離: rMax * 1.50）
  - カメラ切り替え: 2小節ごと（奇数小節のみ）
- **シャドウ**: ON
  - シャドウマップ: 有効（シーン固有）
  - シャドウタイプ: PCFSoftShadowMap
- **トラックオブジェクト**: ON
  - Track1: トーラス（InstancedMesh、最大50個）
  - Track2: ボックス（InstancedMesh、最大50個）
  - Track3: 円柱+サークル（InstancedMesh、最大50個）
  - Track4: 金属片（InstancedMesh、最大50個）
  - 現在は無効化（寿命管理を無効化）

## シェーダー
- **particle_vert.glsl/frag.glsl**: パーティクル描画シェーダー
  - 役割: 球体マッピングされたパーティクルを描画
  - 主要uniforms: baseRadius、heightAmp、noiseScale、noiseSpeed
- **line_vert.glsl/frag.glsl**: 線描画シェーダー
  - 役割: パーティクル間の線を描画（使用状況は要確認）

## パラメータ
- **パーティクル数**: 1,500,625（1225x1225グリッド）
  - 説明: 緯度経度グリッドで球体マッピング
- **baseRadius**: 1.0（デフォルト）
  - 説明: 球体の基準半径
- **heightAmp**: 0.03（デフォルト、非常に薄いノイズ）
  - 説明: 半径変位量（ノイズの強さ）
- **noiseScale**: 2.2（デフォルト）
  - 説明: 空間スケール（ノイズの粗さ）
- **noiseSpeed**: 0.035（デフォルト）
  - 説明: 時間スケール（ノイズの動きの速さ）
- **flowOnSphereEnabled**: 0.0（デフォルトOFF）
  - 説明: 球体マッピングではなく、緯度経度も動かすモード
- **flowOnSphereFreq**: 3.0
  - 説明: flowOnSphereモードの周波数
- **flowOnSphereStrength**: 0.65
  - 説明: flowOnSphereモードの強さ
- **圧力モードパラメータ**:
  - velMax: 0.4-1.3（velocity依存）
  - offsetMax: 999999.0（実質的に上限なし）
  - strength: 0.02-0.12（velocity依存）
  - angle: 0.3-0.8 rad（velocity依存）
- **カメラ設定**:
  - FOV: 60度
  - ニア: 0.01
  - ファー: 100.0
  - ターゲット: (0, 0, 0)
- **RandomLFOパラメータ**（無効化中）:
  - noiseScale: 0.55-3.6（LFO範囲）
  - heightAmp: 0.24-0.92（LFO範囲）
  - noiseSpeed: 0.010-0.060（LFO範囲）
  - LFO周波数: 0.0006-0.0025

## インタラクション
- **キーボード操作**:
  - **p/P**: パーティクル表示のON/OFF
  - **g/G**: 3Dグリッド（GridRuler3D）の表示/非表示
  - **c/C**: カメラパーティクルの可視化（デバッグ用）
  - **h/H**: HUDの表示/非表示
  - **s/S**: 正方形スクリーンショット
  - **y/Y**: 16:9スクリーンショット
  - **r/R**: シーンリセット（キーを離した時）
  - **l/L**: 線描画の表示/非表示（キーを離した時）
  - **u/U**: パーティクル更新方式の切り替え（FULL ⇄ HALF）
  - **n/N**: flowOnSphereモードのON/OFF
  - **m/M**: 圧力モード ⇄ LFOモードの切り替え
- **OSCメッセージ**（トラック別）:
  - **Track1**: 無効化（削除）
  - **Track2**: 色反転エフェクト
    - デフォルト: ON
    - velocity: エフェクト強度（0-127）
    - durationMs: 効果持続時間（デフォルト150ms）
  - **Track3**: 色収差エフェクト
    - デフォルト: ON
    - velocity: エフェクト強度（0-127 → 0.0-1.0）
    - durationMs: 効果持続時間（デフォルト150ms）
  - **Track4**: グリッチエフェクト
    - デフォルト: ON
    - velocity: エフェクト強度（0-127 → 0.0-0.7）
    - durationMs: 効果持続時間（デフォルト150ms）
  - **Track5**: 圧力パルス（球体の高さ変動）
    - デフォルト: ON
    - noteNumber: 使用しない
    - velocity: 圧力の強さ（0-127）
    - durationMs: 使用しない
    - 最大同時インパルス数: 8
    - インディケーター表示: ON（Canvas + 3Dオブジェクト）
    - 前回との間隔で方向を決定（近ければ近い方向、遠ければ遠い方向）

## 実装のポイント
- **ノイズを非常に薄く**: heightAmpを0.03に固定（物凄く薄いノイズ）
- **圧力モードをデフォルトON**: Track5で球体の高さを変動させる
- **カメラモード別の動作**: 8種類のカメラモードで異なる動きを実装
- **球体内部に入らない制限**: カメラが球体内部に入らないよう最小距離でクランプ（サイドパンとスローオービットは除外）
- **actual_tickでLFOを変化**: tickが進むほどLFOのrate範囲を早く、value範囲を広げる（現在は無効化）
- **Track5圧力の連続性**: 前回の圧力位置との間隔で、近ければ近い方向、遠ければ遠い方向に圧力を加える
- **Track5フォローモード**: モード6（follow）はTrack5の最新圧力位置を注視（1秒以上の間隔で更新）

## 今後の拡張予定
- 特に記載なし（現時点で完成度が高い）
