## 概要
- **目的**: MLS-MPM（Material Point Method）を核にした物理シミュレーションベースのパーティクルビジュアル
- **レンダリング方式**: WebGPU（three/webgpu）
- **旧システム**: 旧scene12をWebGPU専用システムのScene01として固定

## 使用技術・ライブラリ
- **MLS-MPM**: ON
  - グリッドサイズ: 64x64x64
  - 最大パーティクル数: 163,840 (8192 * 20)
  - デフォルトパーティクル数: 130,000
  - 初期配置: 箱の壁際まで寄せたランダム配置
- **WebGPU**: ON
  - レンダリング: three/webgpu
  - 非同期更新: 物理シミュレーションは非同期で実行
- **ポストプロセッシング**: ON
  - Bloom: OFF（シーン固有で無効化）
  - 色反転エフェクト: ON（Track2）
  - 色収差エフェクト: ON（Track3）
  - グリッチエフェクト: ON（Track4）
- **HDR環境マップ**: ON
  - ファイル: `autumn_field_puresky_1k.hdr`
  - キャッシュ: 有効（loadHdrCached使用）
- **グリッド/ルーラー**: ON
  - 3Dグリッド: ON（GridRuler3D、デフォルトON）
  - 床グリッド: 有効（opacity: 0.25）
  - HUDグリッド: OFF（デフォルトOFF）
  - 境界Box: ON（ワイヤーフレーム表示）
- **カメラパーティクル**: ON
  - カメラ数: 8台
  - 移動範囲: Box内（X: ±0.7, Y: 0.0-1.05, Z: -1.25±0.8）
  - 最大速度: 0.07
  - 最大力: 0.02
  - 減衰: conf.cameraFriction（デフォルト0.02）または0.0（noDamping時）
- **シャドウ**: ON
  - シャドウマップ: 有効（シーン固有）
  - シャドウタイプ: PCFSoftShadowMap
  - パーティクル影: 有効（castShadow/receiveShadow）

## シェーダー
- **particleRender.vert/frag**: パーティクル描画シェーダー
  - 役割: パーティクルをMeshとして描画
  - 主要uniforms: heatmapMix（グレースケール→ヒートマップの混合率）
- **colorUpdate.vert/frag**: パーティクル色更新シェーダー
  - 役割: パーティクルの色を更新（運動量ベースのヒートマップ）
- **positionUpdate.vert/frag**: パーティクル位置更新シェーダー
  - 役割: MLS-MPMシミュレーションによる位置更新
- **lineRender.vert/frag**: 線描画シェーダー
  - 役割: パーティクル間の線を描画（使用状況は要確認）

## パラメータ
- **パーティクル数**: 130,000（デフォルト）
  - 説明: 物理シミュレーションに参加するパーティクル数。phaseやactual_tickに応じて10%-100%で変化
- **パーティクル形状**: roundedBox（デフォルト）
  - 説明: パーティクルの3D形状。'sphere'（低ポリ球）または'roundedBox'（角丸Box）
- **グリッドサイズ**: 64x64x64
  - 説明: MLS-MPMシミュレーションの空間グリッド解像度
- **境界Boxサイズ**: X: 1.0, Y: 1.0, Z: 0.4（スケール後）
  - 説明: パーティクルが存在する空間の境界
- **カメラ設定**:
  - FOV: 60度
  - ニア: 0.01
  - ファー: 5.0
  - ターゲット: (0, 0.5, 0.0)
- **物理パラメータ**（conf.js）:
  - stiffness: 3.0
  - restDensity: 0.25 * level * density（パーティクル数に応じて動的計算）
  - dynamicViscosity: 0.06
  - gravity: 0
  - heatSpeedMin: 0.0005
  - heatSpeedMax: 0.015
- **phase展開**:
  - USE_ACTUAL_TICK_FOR_PHASE: true
  - 最大tick: 96小節 * 4拍 * 96tick = 36,864 tick
  - 粒数更新量子化: 512

## インタラクション
- **キーボード操作**:
  - **p/P**: パーティクル表示のON/OFF
  - **g/G**: 3Dグリッド（GridRuler3D）の表示/非表示
  - **c/C**: カメラパーティクルの可視化（デバッグ用）
  - **h/H**: HUDの表示/非表示
  - **s/S**: 正方形スクリーンショット
  - **y/Y**: 16:9スクリーンショット
  - **r/R**: シーンリセット（キーを離した時）
  - **l/L**: 線描画の表示/非表示（キーを離した時）
- **OSCメッセージ**（トラック別）:
  - **Track1**: カメラランダマイズ + パーティクルへの力
    - デフォルト: ON
    - velocity: ブースト量（0-127 → 力の倍率）
    - durationMs: 効果持続時間（デフォルト80ms）
  - **Track2**: 色反転エフェクト
    - デフォルト: ON
    - velocity: エフェクト強度（0-127）
    - durationMs: 効果持続時間（デフォルト150ms）
  - **Track3**: 色収差エフェクト
    - デフォルト: ON
    - velocity: エフェクト強度（0-127 → 0.0-1.0）
    - durationMs: 効果持続時間（デフォルト150ms）
  - **Track4**: グリッチエフェクト
    - デフォルト: ON
    - velocity: エフェクト強度（0-127 → 0.0-0.7）
    - durationMs: 効果持続時間（デフォルト150ms）
  - **Track5**: インパルス力（パーティクルへの衝撃）
    - デフォルト: ON
    - noteNumber: 力の位置（グリッド座標）
    - velocity: 力の強度（0-127）
    - durationMs: 効果持続時間（デフォルト120ms）
    - 最大同時インパルス数: 8
    - インディケーター表示: ON（Canvas + 3Dオブジェクト）

## 実装のポイント
- **非同期レンダリング**: MLS-MPMシミュレーションは非同期で実行され、`render()`メソッドで`await`して待機
- **固定delta**: 物理シミュレーションは固定delta（0.016秒）を使用
- **phase展開**: `actual_tick`を使用して滑らかにパーティクル数を10%-100%に展開
- **カメラ制限**: カメラがパーティクルBoxの裏側（+Z側）に回り込まないように制限
- **Track5インパルス**: パーティクルへの衝撃を視覚化するため、Canvas + 3Dオブジェクト（球体+サークル）で表示
- **シャドウ設定**: シーン固有でシャドウを有効化（他のシーンに影響しないよう、conf.bloomを一時的に変更してから戻す）
- **リソース管理**: `setResourceActive()`で非アクティブ時にCanvasを非表示にしてコストを削減

## 今後の拡張予定
- 特に記載なし（現時点で完成度が高い）
